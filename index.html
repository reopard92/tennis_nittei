<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日程回答</title>
<style>
  :root {
    --bg-color: #ffffff;
    --line-green: #06c755;
    --text-color: #111111;
    --gray-text: #888888;
    --border-color: #f0f0f0;
    --purple-icon: #9c59d1;
    --btn-disabled: #dcdcdc;
    --btn-text-disabled: #ffffff;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: #fff;
    margin: 0;
    padding: 0;
    color: var(--text-color);
    padding-bottom: 80px;
  }

  /* ヘッダー */
  .header {
    display: flex; justify-content: space-between; align-items: center;
    height: 44px; padding: 0 15px; border-bottom: 1px solid var(--border-color);
    font-weight: bold; font-size: 1rem; position: sticky; top: 0; background: #fff; z-index: 10;
  }
  .header-icon { font-size: 1.2rem; color: #333; cursor: pointer; width: 24px; text-align: center; }

  /* イベント情報 */
  .event-info {
    padding: 15px 15px 0 15px;
    display: flex; align-items: flex-start;
  }
  .calendar-icon {
    width: 44px; height: 44px; background-color: var(--purple-icon);
    border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 12px; flex-shrink: 0;
  }
  .calendar-icon svg { width: 24px; height: 24px; fill: white; }
  .event-details h2 { font-size: 0.95rem; margin: 0 0 4px 0; }
  .event-details p { font-size: 0.75rem; color: var(--gray-text); margin: 0; }
  .author-name { color: var(--line-green); margin-right: 5px; }

  /* 月切り替えタブ */
  .month-tabs {
    display: flex;
    gap: 10px;
    padding: 15px 15px 0 15px;
    background: #fff;
    border-bottom: 8px solid #f2f4f8;
    overflow-x: auto;
  }
  .tab-btn {
    padding: 8px 16px;
    border-radius: 20px;
    background-color: #f0f0f0;
    color: #666;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap;
    user-select: none;
    margin-bottom: 15px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    background-color: var(--line-green);
    color: white;
    box-shadow: 0 2px 4px rgba(6, 199, 85, 0.3);
  }

  /* 日程リスト */
  .date-list { list-style: none; padding: 0; margin: 0; }
  
  .date-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 18px 15px; border-bottom: 1px solid var(--border-color);
  }
  .date-item.hidden { display: none; }

  .date-text { font-size: 0.95rem; }

  .options-group { display: flex; gap: 20px; }
  .option-label {
    cursor: pointer; display: flex; justify-content: center; align-items: center;
    width: 32px; height: 32px; border-radius: 50%; transition: all 0.2s;
    color: #ccc; font-size: 1.6rem; line-height: 1;
  }
  .option-label input { display: none; }
  .option-label:has(input:checked) { color: #333; transform: scale(1.1); }

  .comment-section { padding: 15px; border-top: 1px solid var(--border-color); }
  .comment-input { width: 100%; border: none; font-size: 0.95rem; outline: none; resize: none; font-family: inherit; }
  
  .footer {
    position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f9f9f9;
    padding: 10px 15px 25px; border-top: 1px solid #e0e0e0; box-sizing: border-box;
  }
  .submit-btn {
    width: 100%; background-color: var(--btn-disabled); color: var(--btn-text-disabled);
    border: none; padding: 14px; border-radius: 6px; font-size: 1rem;
    font-weight: bold; cursor: pointer; transition: background-color 0.3s;
  }
  .submit-btn.active { background-color: var(--line-green); color: white; }

  #loading { padding: 30px; text-align: center; color: #888; font-size: 0.9rem; }
</style>
</head>
<body>

  <header class="header">
    <div class="header-icon">＜</div>
    <div>日程回答</div>
    <div class="header-icon">✕</div>
  </header>

  <div class="event-info">
    <div class="calendar-icon">
      <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
    </div>
    <div class="event-details">
      <h2 id="eventTitle">テニス練習日程</h2> 
      <p><span class="author-name">管理者</span> 自動更新</p>
    </div>
  </div>

  <div class="month-tabs" id="monthTabs"></div>

  <form id="schedule-form">
    <div id="loading">日程を読み込み中...</div>
    <ul class="date-list" id="dateList"></ul>

    <div class="comment-section">
      <textarea id="userComment" class="comment-input" rows="3" placeholder="コメントを入力(200文字以内)"></textarea>
    </div>
  </form>

  <footer class="footer">
    <button class="submit-btn" id="submitBtn" onclick="sendData()">選択</button>
  </footer>

<script>
  // ▼ 更新した新しいGASのURLです
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxkywDklSyaMf93hYhG-ULAyAEQ1qHGgaYjNewTxX34pfySOZKYsbwehygCccEvnchB/exec";
  
  const MY_NAME = "テスト太郎";

  const dateListUl = document.getElementById('dateList');
  const monthTabsDiv = document.getElementById('monthTabs');
  const eventTitle = document.getElementById('eventTitle');
  const loadingDiv = document.getElementById('loading');
  const btn = document.getElementById('submitBtn');

  window.onload = function() {
    fetch(GAS_URL)
      .then(response => response.json())
      .then(data => {
        loadingDiv.style.display = 'none';
        initApp(data);
      })
      .catch(error => {
        console.error(error);
        loadingDiv.innerHTML = "読み込みエラー<br>URLが正しいか確認してください";
      });
  };

  function initApp(data) {
    if (data.length === 0) {
      dateListUl.innerHTML = '<li style="padding:20px; text-align:center;">予定がありません</li>';
      return;
    }

    // 月ごとにユニークなキーを抽出 (例: "2026-01", "2026-02")
    // data.fullDate はGAS側で日本時間に修正済み (yyyy-MM-dd)
    const uniqueMonths = [...new Set(data.map(item => item.fullDate.substring(0, 7)))];
    
    // タブボタン作成
    uniqueMonths.forEach((monthKey, index) => {
      const monthNum = parseInt(monthKey.split('-')[1]); 
      const btn = document.createElement('div');
      btn.className = 'tab-btn';
      btn.innerText = `${monthNum}月`;
      btn.onclick = () => switchMonth(monthKey, monthNum);
      
      // 最初だけアクティブに
      if (index === 0) {
        btn.classList.add('active');
        updateTitle(monthNum);
      }
      monthTabsDiv.appendChild(btn);
    });

    // リスト描画（最初は先頭の月だけ表示）
    generateList(data, uniqueMonths[0]);
  }

  function switchMonth(targetMonthKey, monthNum) {
    updateTitle(monthNum);

    // タブの見た目更新
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => {
      if (tab.innerText === `${monthNum}月`) {
        tab.classList.add('active');
      } else {
        tab.classList.remove('active');
      }
    });

    // リストの表示/非表示切り替え
    const items = document.querySelectorAll('.date-item');
    items.forEach(item => {
      const itemMonth = item.getAttribute('data-month');
      if (itemMonth === targetMonthKey) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });
  }

  function updateTitle(monthNum) {
    eventTitle.innerText = `テニス${monthNum}月`;
  }

  function generateList(scheduleData, initialMonthKey) {
    scheduleData.forEach((item, index) => {
      const groupName = `day_${index}`;
      const monthKey = item.fullDate.substring(0, 7);
      
      // 初期表示月以外は隠す
      const hiddenClass = (monthKey === initialMonthKey) ? '' : 'hidden';

      const html = `
        <li class="date-item ${hiddenClass}" data-month="${monthKey}">
          <span class="date-text">${item.date}</span>
          <div class="options-group">
            <label class="option-label">
              <input type="radio" name="${groupName}" value="ok" data-date="${item.date}">◯
            </label>
            <label class="option-label">
              <input type="radio" name="${groupName}" value="maybe" data-date="${item.date}">△
            </label>
            <label class="option-label">
              <input type="radio" name="${groupName}" value="ng" data-date="${item.date}">✕
            </label>
          </div>
        </li>
      `;
      dateListUl.insertAdjacentHTML('beforeend', html);
    });

    document.getElementById('schedule-form').addEventListener('change', () => {
      btn.classList.add('active');
    });
  }

  function sendData() {
    const activeBtn = document.querySelector('.submit-btn.active');
    if (!activeBtn) return;

    btn.innerText = "送信中...";
    btn.disabled = true;

    const items = document.querySelectorAll('.date-item');
    const comment = document.getElementById('userComment').value;
    const sendPromises = [];

    items.forEach(item => {
      const checkedInput = item.querySelector('input:checked');
      if (checkedInput) {
        const dateStr = checkedInput.getAttribute('data-date');
        const payload = {
          userName: MY_NAME,
          date: dateStr,
          status: checkedInput.value,
          comment: comment
        };

        const request = fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          mode: "no-cors",
          headers: { "Content-Type": "text/plain" }
        });
        sendPromises.push(request);
      }
    });

    if (sendPromises.length === 0) {
      alert("日程を選択してください");
      btn.innerText = "選択";
      btn.disabled = false;
      return;
    }

    Promise.all(sendPromises)
      .then(() => {
        alert("登録しました！");
        btn.innerText = "送信完了";
      })
      .catch(error => {
        alert("送信処理完了");
        btn.innerText = "送信完了";
      });
  }
</script>

</body>
</html>
