<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>日程回答</title>
<script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root {
    --text-color: #111111;
    --border-color: #f0f0f0;
    --purple-icon: #9c59d1;
    --btn-disabled: #dcdcdc;
    --btn-text-disabled: #ffffff;
    --line-green: #06c755;
    
    /* 曜日カラー */
    --sat-color: #0066cc;
    --sun-color: #cc0000;

    /* 選択時のカラー */
    --ok-bg: #28a745;
    --maybe-bg: #fd7e14;
    --ng-bg: #dc3545;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background-color: #fff;
    margin: 0; padding: 0;
    color: var(--text-color);
    padding-bottom: 90px;
  }

  .header {
    display: flex; justify-content: center; align-items: center;
    height: 44px; border-bottom: 1px solid var(--border-color);
    font-weight: bold; font-size: 1rem; position: sticky; top: 0; background: #fff; z-index: 10;
  }

  .user-bar {
    background-color: #f2f4f8; padding: 8px 15px; font-size: 0.85rem;
    color: #555; display: flex; align-items: center; justify-content: space-between;
  }
  .user-name-display { font-weight: bold; color: var(--line-green); }

  .event-info { padding: 15px 15px 0 15px; display: flex; align-items: center; }
  .calendar-icon {
    width: 44px; height: 44px; background-color: var(--purple-icon);
    border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 12px; flex-shrink: 0;
  }
  .calendar-icon svg { width: 24px; height: 24px; fill: white; }
  .event-details h2 { font-size: 1rem; margin: 0; }

  .month-tabs {
    display: flex; gap: 10px; padding: 15px 15px 0 15px;
    background: #fff; border-bottom: 8px solid #f2f4f8; overflow-x: auto;
  }
  .tab-btn {
    padding: 8px 16px; border-radius: 20px; background-color: #f0f0f0; color: #666;
    font-size: 0.9rem; font-weight: bold; cursor: pointer; white-space: nowrap;
    user-select: none; margin-bottom: 15px; transition: all 0.2s;
  }
  .tab-btn.active {
    background-color: var(--line-green); color: white;
    box-shadow: 0 2px 4px rgba(6, 199, 85, 0.3);
  }

  .date-list { list-style: none; padding: 0; margin: 0; }
  .date-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 18px 15px; border-bottom: 1px solid var(--border-color);
  }
  .date-item.hidden { display: none; }
  
  .date-text { font-size: 1rem; font-weight: 500; }
  .sat { color: var(--sat-color); }
  .sun { color: var(--sun-color); }

  .options-group { display: flex; gap: 15px; }
  .option-label {
    cursor: pointer; display: flex; justify-content: center; align-items: center;
    width: 36px; height: 36px; border-radius: 50%; transition: all 0.2s;
    color: #ccc; font-size: 1.2rem; font-weight: bold;
    background-color: #f9f9f9;
  }
  .option-label input { display: none; }

  .option-label:has(input[value="ok"]:checked) {
    background-color: var(--ok-bg); color: white; transform: scale(1.1); box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
  }
  .option-label:has(input[value="maybe"]:checked) {
    background-color: var(--maybe-bg); color: white; transform: scale(1.1); box-shadow: 0 2px 5px rgba(253, 126, 20, 0.3);
  }
  .option-label:has(input[value="ng"]:checked) {
    background-color: var(--ng-bg); color: white; transform: scale(1.1); box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
  }

  .comment-section { padding: 15px; border-top: 1px solid var(--border-color); }
  .comment-input { width: 100%; border: none; font-size: 0.95rem; outline: none; resize: none; font-family: inherit; }
  
  .footer {
    position: fixed; bottom: 0; left: 0; width: 100%; background-color: #f9f9f9;
    padding: 10px 15px 25px; border-top: 1px solid #e0e0e0; box-sizing: border-box; z-index: 20;
  }
  .submit-btn {
    width: 100%; background-color: var(--btn-disabled); color: var(--btn-text-disabled);
    border: none; padding: 14px; border-radius: 6px; font-size: 1rem;
    font-weight: bold; cursor: pointer; transition: background-color 0.3s;
  }
  .submit-btn.active { background-color: var(--line-green); color: white; }

  #loading { padding: 30px; text-align: center; color: #888; font-size: 0.9rem; }
</style>
</head>
<body>

  <header class="header">
    <div>日程回答</div>
  </header>

  <div class="user-bar">
    <span>ログイン中: <span id="loginName" class="user-name-display">読み込み中...</span></span>
  </div>

  <div class="event-info">
    <div class="calendar-icon">
      <svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>
    </div>
    <div class="event-details">
      <h2 id="eventTitle">テニス練習日程</h2>
    </div>
  </div>

  <div class="month-tabs" id="monthTabs"></div>

  <form id="schedule-form">
    <div id="loading">LIFF認証 & 日程読み込み中...</div>
    <ul class="date-list" id="dateList"></ul>

    <div class="comment-section">
      <textarea id="userComment" class="comment-input" rows="3" placeholder="コメントを入力(200文字以内)"></textarea>
    </div>
  </form>

  <footer class="footer">
    <button class="submit-btn" id="submitBtn" onclick="sendData()">選択</button>
  </footer>

<script>
  // あなたの設定
  const LIFF_ID = "2008858372-NgwrDQlQ";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxkywDklSyaMf93hYhG-ULAyAEQ1qHGgaYjNewTxX34pfySOZKYsbwehygCccEvnchB/exec";
  
  let myLineName = "";

  const dateListUl = document.getElementById('dateList');
  const monthTabsDiv = document.getElementById('monthTabs');
  const eventTitle = document.getElementById('eventTitle');
  const loadingDiv = document.getElementById('loading');
  const btn = document.getElementById('submitBtn');
  const loginNameSpan = document.getElementById('loginName');
  const userComment = document.getElementById('userComment');

  window.onload = function() {
    initializeLiff();
  };

  async function initializeLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }
      const profile = await liff.getProfile();
      myLineName = profile.displayName;
      loginNameSpan.innerText = myLineName;
      
      // 日程読み込み開始
      fetchSchedule();

    } catch (err) {
      console.error('LIFF Error:', err);
      loadingDiv.innerHTML = "エラーが発生しました。<br>LINEから開いていますか？";
    }
  }

  // 1. カレンダー枠の取得
  function fetchSchedule() {
    fetch(GAS_URL)
      .then(response => response.json())
      .then(data => {
        initApp(data);
        // カレンダー枠ができたら、次に「自分の過去の回答」を取りに行く
        fetchMyHistory();
      })
      .catch(error => {
        console.error(error);
        loadingDiv.innerHTML = "日程の読み込みに失敗しました";
      });
  }

  // 2. 自分の回答履歴の取得
  function fetchMyHistory() {
    // GASに「?mode=history&name=自分」で問い合わせる
    const historyUrl = `${GAS_URL}?mode=history&name=${encodeURIComponent(myLineName)}`;
    
    fetch(historyUrl)
      .then(res => res.json())
      .then(history => {
        loadingDiv.style.display = 'none'; // ロード完了
        applyHistory(history);
      })
      .catch(err => {
        console.error("履歴取得エラー:", err);
        loadingDiv.style.display = 'none'; // エラーでも画面は出す
      });
  }

  // 3. 画面に履歴を反映させる
  function applyHistory(history) {
    if (!history || Object.keys(history).length === 0) return;

    // 画面上の全日程をループしてチェックを入れる
    const items = document.querySelectorAll('.date-item');
    let hasData = false;
    let lastComment = "";

    items.forEach(item => {
      // ラジオボタンのどれか1つから日付(data-date)を取得
      const radio = item.querySelector('input');
      const dateStr = radio.getAttribute('data-date');
      
      // 履歴の中にこの日付のデータがあるか？
      if (history[dateStr]) {
        const status = history[dateStr].status; // ok, maybe, ng
        const comment = history[dateStr].comment;
        
        // そのステータスのラジオボタンを探してチェックする
        const targetRadio = item.querySelector(`input[value="${status}"]`);
        if (targetRadio) {
          targetRadio.checked = true;
          hasData = true;
        }
        if (comment) lastComment = comment;
      }
    });

    if (hasData) {
      btn.innerText = "更新する"; // 既にデータがあればボタン名を変える
      btn.classList.add('active'); // ボタン有効化
      if (lastComment) userComment.value = lastComment;
    }
  }

  function initApp(data) {
    if (data.length === 0) {
      dateListUl.innerHTML = '<li style="padding:20px; text-align:center;">予定がありません</li>';
      return;
    }
    const uniqueMonths = [...new Set(data.map(item => item.fullDate.substring(0, 7)))];
    uniqueMonths.forEach((monthKey, index) => {
      const monthNum = parseInt(monthKey.split('-')[1]); 
      const btn = document.createElement('div');
      btn.className = 'tab-btn';
      btn.innerText = `${monthNum}月`;
      btn.onclick = () => switchMonth(monthKey, monthNum);
      if (index === 0) {
        btn.classList.add('active');
        updateTitle(monthNum);
      }
      monthTabsDiv.appendChild(btn);
    });
    generateList(data, uniqueMonths[0]);
  }

  function switchMonth(targetMonthKey, monthNum) {
    updateTitle(monthNum);
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => {
      if (tab.innerText === `${monthNum}月`) tab.classList.add('active');
      else tab.classList.remove('active');
    });
    const items = document.querySelectorAll('.date-item');
    items.forEach(item => {
      const itemMonth = item.getAttribute('data-month');
      if (itemMonth === targetMonthKey) item.classList.remove('hidden');
      else item.classList.add('hidden');
    });
  }

  function updateTitle(monthNum) {
    eventTitle.innerText = `テニス${monthNum}月`;
  }

  function generateList(scheduleData, initialMonthKey) {
    scheduleData.forEach((item, index) => {
      const groupName = `day_${index}`;
      const monthKey = item.fullDate.substring(0, 7);
      const hiddenClass = (monthKey === initialMonthKey) ? '' : 'hidden';

      let formattedDate = item.date;
      if (item.date.includes('(土)')) {
        formattedDate = item.date.replace('(土)', '<span class="sat">(土)</span>');
      } else {
        formattedDate = item.date.replace(/(\(.\))/, '<span class="sun">$1</span>');
      }

      const html = `
        <li class="date-item ${hiddenClass}" data-month="${monthKey}">
          <span class="date-text">${formattedDate}</span>
          <div class="options-group">
            <label class="option-label"><input type="radio" name="${groupName}" value="ok" data-date="${item.date}">◯</label>
            <label class="option-label"><input type="radio" name="${groupName}" value="maybe" data-date="${item.date}">△</label>
            <label class="option-label"><input type="radio" name="${groupName}" value="ng" data-date="${item.date}">✕</label>
          </div>
        </li>
      `;
      dateListUl.insertAdjacentHTML('beforeend', html);
    });

    document.getElementById('schedule-form').addEventListener('change', () => {
      btn.classList.add('active');
      btn.innerText = `${myLineName} として回答`;
    });
  }

  function sendData() {
    const activeBtn = document.querySelector('.submit-btn.active');
    if (!activeBtn) return;
    if (!myLineName) { alert("LINEログイン情報が取得できていません。"); return; }

    btn.innerText = "送信中...";
    btn.disabled = true;

    const items = document.querySelectorAll('.date-item');
    const comment = document.getElementById('userComment').value;
    const sendPromises = [];

    items.forEach(item => {
      const checkedInput = item.querySelector('input:checked');
      if (checkedInput) {
        const dateStr = checkedInput.getAttribute('data-date');
        const payload = {
          userName: myLineName,
          date: dateStr,
          status: checkedInput.value,
          comment: comment
        };
        const request = fetch(GAS_URL, {
          method: "POST",
          body: JSON.stringify(payload),
          mode: "no-cors",
          headers: { "Content-Type": "text/plain" }
        });
        sendPromises.push(request);
      }
    });

    if (sendPromises.length === 0) {
      alert("日程を選択してください");
      btn.innerText = "選択";
      btn.disabled = false;
      return;
    }

    Promise.all(sendPromises)
      .then(() => {
        alert("登録(更新)しました！");
        liff.closeWindow(); 
      })
      .catch(error => {
        alert("送信処理完了");
        liff.closeWindow();
      });
  }
</script>

</body>
</html>
