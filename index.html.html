<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CODE NAME: 26 PWA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="TENNIS">
    <link rel="apple-touch-icon" href="icon.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* =========================================
           GLOBAL THEME: DEEP SPACE (12/3 1:00 Ver. Preserved)
           ========================================= */
        body {
            font-family: "Helvetica Neue", "Segoe UI", Arial, sans-serif;
            background-color: #020204;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 1px, transparent 1.5px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 1.5px),
                radial-gradient(white, rgba(255,255,255,.1) 1.5px, transparent 2px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            color: #e6e6e6;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(20, 20, 30, 0.4);
            padding: 30px;
            border-radius: 2px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            position: relative;
            margin-top: 20px;
            min-height: 80vh;
        }
        .app-header {
            text-align: center;
            margin-bottom: 40px;
            padding-top: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }
        h1 {
            text-align: center;
            color: #ffffff;
            font-weight: 300;
            font-size: 1.8rem;
            letter-spacing: 4px;
            margin: 0;
            padding-top: 15px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
        }
        .subtitle {
            font-size: 0.8rem;
            color: #81d4fa;
            letter-spacing: 2px;
            margin-top: 5px;
        }
        /* REFRESH button removed */

        .view-section { display: none; animation: fadeIn 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT STYLES */
        .input-header-area { position: relative; margin-bottom: 40px; min-height: 80px; }
        #matchDate { position: absolute; top: 5px; right: 0; color: #fff; font-size: 0.9rem; letter-spacing: 1px; }
        #courtSelect {
            display: block; margin: 0 auto; padding: 5px 10px; font-size: 1rem;
            border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.6); color: #fff; text-align: center; cursor: pointer;
            width: 100%; max-width: 300px;
        }
        #courtSelect:focus { outline: none; border-bottom-color: #fff; background-color: #000; }
        #courtSelect option { background-color: #000; color: #fff; }
        .coin-toss-section { position: absolute; top: 0; left: 0; width: 80px; text-align: center; }
        .coin {
            width: 36px; height: 36px; margin: 0 auto 5px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #b0bec5);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: bold; color: #333;
            cursor: pointer;
        }
        /* btn-toss removed */
        .spinning { animation: spin 0.5s infinite ease-in-out; }
        @keyframes spin { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }
        .round-title {
            color: #fff; font-size: 1rem; font-weight: 300; letter-spacing: 3px;
            margin-bottom: 20px; border-left: 2px solid rgba(255, 255, 255, 0.5); padding-left: 12px; display: inline-block;
        }
        .player-inputs { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 25px; }
        .input-group label { display: block; margin-bottom: 6px; font-size: 0.7rem; color: #666; text-align: center; }
        select.player-select {
            width: 100%; padding: 8px 4px; font-size: 0.9rem;
            background-color: rgba(20, 20, 30, 0.8); border: 1px solid rgba(255, 255, 255, 0.1);
            color: #eee; border-radius: 2px; text-align: center;
        }
        select.player-select:disabled { opacity: 0.3; }
        select.player-select option { background-color: #000; color: #fff; }
        select.player-select option:disabled { color: #555 !important; background-color: #111; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; background: transparent; }
        th { background: transparent; color: #888; font-weight: 300; font-size: 0.75rem; padding: 10px; text-align: center; }
        td { padding: 12px 5px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.03); font-size: 0.9rem; color: #ddd; }
        .rank-1 { color: #fff; font-weight: bold; text-shadow: 0 0 10px rgba(255, 255, 255, 0.8); }
        .game-count { font-weight: normal; color: #81d4fa; }
        .rest-highlight { color: #e57373; font-size: 0.85rem; padding: 2px 8px; border: none; }
        
        .score-select { 
            width: 45px; padding: 5px; text-align: center; font-size: 1rem; 
            background-color: #222; border: 1px solid #666; color: #fff; border-radius: 2px; 
        }
        .score-select:focus { outline: none; border-color: #00ffff; background-color: #000; }
        .score-select.filled { background-color: rgba(0, 255, 255, 0.15); border-color: rgba(0, 255, 255, 0.6); font-weight: bold; color: #00ffff; }

        .winner { background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent); color: #fff !important; font-weight: bold; text-shadow: 0 0 8px rgba(255, 255, 255, 0.5); }
        .loser { color: #555 !important; }
        .loser select { opacity: 0.3; }
        .btn-ctrl { background: transparent; color: #777; border: 1px solid rgba(255, 255, 255, 0.1); padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 0.75rem; margin-left: 10px; }
        .btn-ctrl.unlocked { border-color: #69f0ae; color: #69f0ae; }
        .btn-send { background: linear-gradient(135deg, #303f9f 0%, #7b1fa2 100%); color: #fff; border: none; padding: 15px 40px; border-radius: 2px; cursor: pointer; font-size: 0.95rem; letter-spacing: 3px; width: 100%; max-width: 350px; margin: 60px auto 0 auto; display: block; box-shadow: 0 10px 30px rgba(48, 63, 159, 0.3); }
        .btn-send:hover { background: linear-gradient(135deg, #3f51b5 0%, #8e24aa 100%); }
        .btn-send:disabled { background: #333; color: #777; cursor: not-allowed; box-shadow: none; }

        /* Layout control for header buttons */
        .header-ctrl-area { position: absolute; top: 0; right: 0; margin-top: 60px; display: flex; gap: 10px; }
        
        /* ANALYSIS STYLES */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: rgba(20, 20, 30, 0.4); padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .stat-label { font-size: 0.7rem; color: #888; margin-bottom: 5px; font-weight: bold; }
        .stat-value { font-size: 1.8rem; color: #fff; font-weight: 300; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .stat-value.highlight { color: #00ffff; text-shadow: 0 0 10px rgba(0,255,255,0.6); }
        .section-title { font-size: 1.1rem; color: #fff; font-weight: 300; letter-spacing: 2px; margin-bottom: 20px; border-left: 3px solid #00ffff; padding-left: 15px; }
        .medal-icon { display: inline-block; margin-left: 4px; font-size: 0.9rem; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        .rank-icon { display: inline-block; margin-right: 6px; font-size: 1rem; filter: drop-shadow(0 0 5px rgba(0,255,255,0.6)); }
        .medal-legend, .rank-legend { text-align: center; color: #888; font-size: 0.7rem; margin-bottom: 20px; line-height: 1.8; }
        .rank-legend { color: #00ffff; border-top: 1px solid rgba(0, 255, 255, 0.1); padding-top: 10px; margin-top: -10px; }
        .log-item { background: rgba(20, 20, 30, 0.4); border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 5px; }
        .log-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .log-header:hover { background: rgba(255, 255, 255, 0.05); }
        .log-date { color: #fff; font-weight: bold; font-size: 1rem; }
        .log-content { display: none; padding: 15px; background: rgba(0, 0, 0, 0.3); }
        .log-content.open { display: block; animation: fadeIn 0.3s; }
        #playerModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: rgba(15, 20, 30, 0.95); border: 1px solid #00ffff; box-shadow: 0 0 30px rgba(0, 255, 255, 0.2); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 30px; position: relative; }
        .close-btn { position: absolute; top: 15px; right: 15px; color: #fff; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-title { color: #fff; font-weight: 300; text-align: center; font-size: 1.5rem; margin-bottom: 10px; letter-spacing: 2px; }
        .modal-medals { text-align: center; margin-bottom: 20px; font-size: 1.2rem; }
        .rank-info-area { background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 25px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .rank-name { font-size: 1.1rem; color: #00ffff; letter-spacing: 2px; margin-bottom: 5px; font-weight: 300; }
        .rank-progress-text { font-size: 0.8rem; color: #aaa; margin-bottom: 8px; }
        .rank-bar-bg { width: 100%; height: 2px; background: #333; }
        .rank-bar-fill { height: 100%; background: #00ffff; width: 0%; box-shadow: 0 0 10px #00ffff; }
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 30px; }
        
        /* Dropdown styles for Ranking page */
        .sector-select {
            padding: 8px 15px; font-size: 1rem;
            background-color: rgba(0, 0, 0, 0.6); color: #00ffff;
            border: 1px solid rgba(0, 255, 255, 0.5); border-radius: 4px;
            outline: none; cursor: pointer; width: 100%; max-width: 300px; display: block; margin: 0 auto;
        }

        .sector-filter::-webkit-scrollbar { display: none; }

        /* LEARN PAGE STYLES (Option B: Hologram/Glass Style) */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .video-card {
            background: rgba(20, 30, 40, 0.4); /* Semi-transparent */
            backdrop-filter: blur(10px); /* Glass effect */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.3); /* Highlight top */
            border-radius: 12px; /* Rounded corners */
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4), inset 0 0 10px rgba(0, 255, 255, 0.1);
            border-color: rgba(0, 255, 255, 0.5);
        }
        .video-thumb {
            position: relative;
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-color: #000;
            background-size: cover;
            background-position: center;
        }
        .video-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
        }
        .video-card:hover .video-overlay {
            background: rgba(0, 0, 0, 0.1);
        }

        .video-play-icon {
            font-size: 2.5rem;
            color: rgba(255, 255, 255, 0.9);
            width: 60px; height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            transition: 0.3s;
            text-shadow: 0 0 10px rgba(0,255,255,0.8);
        }
        .video-card:hover .video-play-icon {
            background: rgba(0, 255, 255, 0.2);
            transform: scale(1.1);
            border-color: #00ffff;
        }

        .video-info {
            padding: 15px;
        }
        .video-title {
            color: #fff;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
            line-height: 1.4;
            text-shadow: 0 0 5px rgba(255,255,255,0.2);
        }
        .video-meta {
            font-size: 0.7rem;
            color: #81d4fa;
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        /* Video Modal */
        #videoModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center;
        }
        .video-container {
            width: 100%; max-width: 100%; aspect-ratio: 16/9;
            background: #000; border: 1px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }
        #videoPlayer {
            width: 100%;
            height: 100%;
        }
        iframe { width: 100%; height: 100%; border: none; }


        /* FOOTER */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.15); display: flex; justify-content: space-around; padding: 10px 0; z-index: 1000; }
        .nav-item { background: none; border: none; color: #555; font-size: 0.6rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 20%; }
        .nav-icon { font-size: 1.2rem; margin-bottom: 3px; filter: grayscale(100%) brightness(0.7); }
        .nav-item.active { color: #fff; }
        .nav-item.active .nav-icon { filter: grayscale(0%) brightness(1.5) drop-shadow(0 0 5px rgba(0,255,255,0.8)); }

        #toast { visibility: hidden; min-width: 250px; background-color: rgba(0,0,0,0.9); color: #fff; border: 1px solid rgba(255,255,255,0.2); text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 90px; transform: translateX(-50%); opacity: 0; transition: 0.4s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #020204; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.8s ease; }
        .loader-text { font-family: 'Courier New', Courier, monospace; color: #00ffff; font-size: 1.2rem; letter-spacing: 4px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .loader-bar { width: 200px; height: 1px; background: rgba(255,255,255,0.2); position: relative; overflow: hidden; }
        .loader-bar::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: #fff; box-shadow: 0 0 10px #fff; animation: load 2s ease-in-out forwards; }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }
        .no-data { text-align: center; padding: 20px; font-size: 0.8rem; color: #666; }

        /* =========================================
           MAP / INFO CARD STYLES
           ========================================= */
        .map-frame {
            position: relative; width: 100%; padding-bottom: 75%; height: 0; 
            overflow: hidden; border: 1px solid #00ffff; 
            box-shadow: 0 0 15px rgba(0,255,255,0.15); margin-bottom: 20px;
            background: #000;
        }
        .map-frame iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* Map filter for Sci-Fi look */
            filter: invert(100%) hue-rotate(180deg) brightness(0.85) contrast(1.2) grayscale(0.5);
        }
        .info-card {
            background: rgba(20, 30, 40, 0.6); 
            border: 1px solid rgba(255,255,255,0.15); 
            padding: 20px; 
            border-left: 3px solid #00ffff;
            animation: fadeIn 0.5s ease;
        }
        .info-row {
            display: flex; margin-bottom: 12px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            padding-bottom: 6px;
        }
        .info-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .info-label { width: 80px; color: #00ffff; font-size: 0.75rem; letter-spacing: 1px; align-self: center; }
        .info-val { color: #fff; font-size: 0.9rem; flex: 1; word-break: break-all; }
        .empty-map-state {
            text-align: center; padding: 60px 0; color: #666; 
            font-family: 'Courier New', monospace; letter-spacing: 2px;
            border: 1px dashed rgba(255,255,255,0.1);
        }


        /* =========================================
           SMARTPHONE OPTIMIZATION (Layout Fix: Full Width & Align)
           ========================================= */
        @media (max-width: 600px) {
            /* „Ç≥„É≥„ÉÜ„Éä„ÅÆ‰ΩôÁôΩ„ÇíÊ•µÈôê„Åæ„ÅßÂâä„Çã */
            .container { padding: 5px; padding-bottom: 80px; }
            .header-area { margin-top: 10px; }
            
            /* --- HEADER LAYOUT FIX FOR MOBILE --- */
            .input-header-area {
                display: grid;
                grid-template-columns: 1fr 1fr;
                row-gap: 15px;
                padding-bottom: 10px;
                min-height: auto;
                margin-bottom: 20px;
            }
            .coin-toss-section {
                position: relative;
                top: auto; left: auto;
                width: auto;
                grid-column: 1;
                /* „Äê‰øÆÊ≠£ 09„ÄëLeft align coin, remove flex column, zero margins */
                text-align: left;
                display: block;
                margin-left: 0;
            }
            #matchDate {
                position: relative;
                top: auto; right: auto;
                grid-column: 2;
                text-align: right;
                font-size: 0.8rem;
                margin-top: 8px; /* Vertical align adjustment */
            }
            #courtSelect {
                grid-column: 1 / 3;
                width: 80%; /* not 100% to look like a centered box */
                max-width: 300px;
                margin: 0 auto; /* Center alignment */
                display: block;
                /* „Äê‰øÆÊ≠£„ÄëCenter text in dropdown */
                text-align: center;
                text-align-last: center; /* For iOS Safari */
            }
            .header-ctrl-area {
                position: relative;
                top: auto; right: auto;
                margin-top: 0;
                grid-column: 1 / 3;
                justify-content: flex-end;
            }
            
            /* „Äê‰øÆÊ≠£ 09„ÄëLarger Icon, force no margin to sit on left edge */
            .coin { width: 40px; height: 40px; font-size: 0.7rem; margin: 0; }
            /* ----------------------------------- */
            
            .player-inputs {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .input-group {
                display: flex;
                align-items: center;
                background: rgba(255,255,255,0.05);
                padding: 5px 10px;
                border-radius: 4px;
            }
            .input-group label {
                margin-bottom: 0;
                margin-right: 10px;
                width: 20px;
                font-size: 0.8rem;
            }
            
            /* „Äê‰øÆÊ≠£„ÄëCenter Title, Remove Left Padding */
            h1 { font-size: 1.4rem; padding-left: 0; text-align: center; }

            /* „Äê‰øÆÊ≠£„ÄëINPUT„ÉÜ„Éº„Éñ„É´: ÂπÖÂà∂Èôê„Å™„Åó (100%) */
            #r1_matchTableBody, #r2_matchTableBody {
                display: block;
                width: 100%; /* „Éï„É´„ÉØ„Ç§„Éâ */
            }
            
            /* „ÄêÈáçË¶Å‰øÆÊ≠£„Äë„ÉÜ„Éº„Éñ„É´Ëá™‰Ωì„ÅÆË°®Á§∫ÂΩ¢Âºè„ÇíÂ§âÊõ¥„Åó„ÄÅÂπÖ„ÇíÂº∑Âà∂Á¢∫‰øù */
            table {
                width: 100% !important;
                display: block;
            }
            
            /* „Äê‰øÆÊ≠£ 03/04„ÄëINPUTÂØæÊà¶„ÉÜ„Éº„Éñ„É´‰ª•Â§ñ„ÅÆ„ÉÜ„Éº„Éñ„É´Ôºà„É©„É≥„Ç≠„É≥„Ç∞„ÄÅ„Éö„Ç¢„ÄÅ„É≠„Ç∞Ôºâ„ÇíÈÄöÂ∏∏Ë°®Á§∫„Å´Êàª„Åô */
            .standard-table {
                display: table !important; /* „Éñ„É≠„ÉÉ„ÇØËß£Èô§ */
                width: 100% !important;
                box-sizing: border-box;
            }
            .standard-table thead { display: table-header-group !important; }
            .standard-table tbody { display: table-row-group !important; }
            .standard-table tr { 
                display: table-row !important; 
                width: auto !important; 
                grid-template-columns: none !important; /* gridËß£Èô§ */
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            .standard-table th, .standard-table td {
                display: table-cell !important;
                width: auto !important;
                text-align: center !important;
                border-bottom: 1px solid rgba(255,255,255,0.1) !important;
            }

            .input-match-table thead {
                display: none;
            }
            
            #r1_matchTableBody tr, #r2_matchTableBody tr {
                display: grid;
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto;
                gap: 5px;
                margin-bottom: 15px; 
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 4px;
                background: rgba(20,20,30,0.6);
                padding: 10px;
                
                /* „Äê‰øÆÊ≠£„ÄëÂπÖ„ÇíÂõ∫ÂÆö„Åõ„Åö100%„Å´„Åô„Çã (max-widthÂâäÈô§) */
                width: 100% !important;
                max-width: none !important;
                margin-left: 0;
                margin-right: 0;
                box-sizing: border-box; 
            }
            
            #r1_matchTableBody td, #r2_matchTableBody td {
                display: block;
                width: 100%;
                box-sizing: border-box;
                border: none;
                padding: 2px 0;
                text-align: center;
            }

            /* 1. Ë©¶ÂêàÁï™Âè∑ */
            #r1_matchTableBody td:nth-of-type(1), #r2_matchTableBody td:nth-of-type(1) {
                grid-row: 1;
                text-align: center;
                font-size: 0.8rem;
                color: #888;
                border-bottom: 1px solid rgba(255,255,255,0.05);
                padding-bottom: 5px;
                margin-bottom: 5px;
            }
            
            /* 2. „Éö„Ç¢A (ÂêçÂâç) „Äê‰øÆÊ≠£ÔºöÂ∑¶ÂØÑ„Åõ„Äë */
            #r1_matchTableBody td:nth-of-type(2), #r2_matchTableBody td:nth-of-type(2) {
                grid-row: 2;
                text-align: left !important; /* Âº∑Âà∂Â∑¶ÂØÑ„Åõ */
                font-size: 0.9rem;
                border: none;
                padding: 2px 0;
                color: #fff;
                white-space: normal; /* Êäò„ÇäËøî„ÅóË®±ÂèØ */
                word-break: break-all;
            }
            
            /* 3. „Çπ„Ç≥„Ç¢A */
            #r1_matchTableBody td:nth-of-type(3), #r2_matchTableBody td:nth-of-type(3) {
                grid-row: 3;
                text-align: left;
                border: none;
                padding: 0;
                display: flex;
                align-items: center;
            }

            /* 4. VS & „Ç≤„Éº„Ç∏ (‰∏≠Â§Æ) */
            #r1_matchTableBody td:nth-of-type(4), #r2_matchTableBody td:nth-of-type(4) {
                grid-row: 3;
                text-align: center;
                border: none;
                padding: 0;
                display: flex;
                justify-content: center;
                align-items: center;
                width: 100%;
            }
            #r1_matchTableBody td:nth-of-type(4) div, #r2_matchTableBody td:nth-of-type(4) div {
                width: 100%;
                display: flex;
                justify-content: center;
                gap: 5px;
            }

            /* 5. „Çπ„Ç≥„Ç¢B */
             #r1_matchTableBody td:nth-of-type(5), #r2_matchTableBody td:nth-of-type(5) {
                grid-row: 3;
                text-align: right;
                border: none;
                padding: 0;
                display: flex;
                justify-content: flex-end;
                align-items: center;
            }

            /* 6. „Éö„Ç¢B (ÂêçÂâç) „Äê‰øÆÊ≠£ÔºöÂè≥ÂØÑ„Åõ„Äë */
            #r1_matchTableBody td:nth-of-type(6), #r2_matchTableBody td:nth-of-type(6) {
                grid-row: 4;
                text-align: right !important; /* Âº∑Âà∂Âè≥ÂØÑ„Åõ */
                font-size: 0.9rem;
                border: none;
                padding: 2px 0;
                color: #fff;
                white-space: normal; /* Êäò„ÇäËøî„ÅóË®±ÂèØ */
                word-break: break-all;
            }

            /* 7. REST */
            #r1_matchTableBody td:nth-of-type(7), #r2_matchTableBody td:nth-of-type(7) {
                grid-row: 5;
                text-align: center;
                margin-top: 10px;
                padding-top: 5px;
                border-top: 1px solid rgba(255,255,255,0.05);
                border-bottom: none;
            }
            #r1_matchTableBody td:nth-of-type(7)::before, #r2_matchTableBody td:nth-of-type(7)::before {
                content: "REST: ";
                color: #888;
            }
            
            /* ÈÖçÁΩÆË™øÊï¥Áî®„ÅÆ„Ç∞„É™„ÉÉ„ÉâÂÜçÂÆöÁæ©ÔºàË°åÂÜÖÔºâ */
            #r1_matchTableBody tr, #r2_matchTableBody tr {
                 grid-template-columns: 60px 1fr 60px; /* „Çπ„Ç≥„Ç¢ - ÂêçÂâç/VS - „Çπ„Ç≥„Ç¢ */
            }
            #r1_matchTableBody td:nth-of-type(1), 
            #r1_matchTableBody td:nth-of-type(2), 
            #r1_matchTableBody td:nth-of-type(6), 
            #r1_matchTableBody td:nth-of-type(7),
            #r2_matchTableBody td:nth-of-type(1), 
            #r2_matchTableBody td:nth-of-type(2), 
            #r2_matchTableBody td:nth-of-type(6), 
            #r2_matchTableBody td:nth-of-type(7) {
                grid-column: 1 / 4; /* ÂÖ®ÂπÖ */
            }
            #r1_matchTableBody td:nth-of-type(3), #r2_matchTableBody td:nth-of-type(3) {
                grid-column: 1; /* Â∑¶ */
            }
            #r1_matchTableBody td:nth-of-type(4), #r2_matchTableBody td:nth-of-type(4) {
                grid-column: 2; /* ‰∏≠Â§Æ (VS„Ç≤„Éº„Ç∏) */
            }
             #r1_matchTableBody td:nth-of-type(5), #r2_matchTableBody td:nth-of-type(5) {
                grid-column: 3; /* Âè≥ */
            }
            
            .stat-value { font-size: 1.5rem; }
            /* Legend Fix for Mobile: Horizontal */
            .medal-legend span, .rank-legend span { display: inline-block; margin-right: 8px; margin-bottom: 3px; font-size: 0.65rem; }
            
            /* „Äê‰øÆÊ≠£ 21„Äë Mobile Video Grid: 2 Columns */
            .video-grid {
                grid-template-columns: repeat(2, 1fr); /* 2 columns */
                gap: 10px;
            }
            .video-title { font-size: 0.75rem; }
            .video-meta { font-size: 0.6rem; }
            .video-info { padding: 10px; }
            .video-play-icon { width: 40px; height: 40px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<div id="loadingScreen">
    <div class="loader-text">SYSTEM INITIALIZING...</div>
    <div class="loader-bar"></div>
</div>

<div class="container">
    <header class="app-header">
        <h1 id="pageTitle">TENNIS CHRONICLES</h1>
        <div class="subtitle">DEEP SPACE INTEGRATED SYSTEM</div>
    </header>

    <div id="view-match" class="view-section active">
        <div class="input-header-area">
            <div class="coin-toss-section">
                <div id="coin" class="coin" onclick="startCoinToss()">HEAD</div>
            </div>
            <div id="matchDate"></div>
            <select id="courtSelect" onchange="saveState()" disabled>
                <option value="-">-</option>
                <option value="Á∑¥È¶¨„Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥">Á∑¥È¶¨„Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥</option>
                <option value="ÁôæËçâ„ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥">ÁôæËçâ„ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥</option>
                <option value="„É¢„É™„Éë„Éº„ÇØ „ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥">„É¢„É™„Éë„Éº„ÇØ „ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥</option>
                <option value="ÁôΩÂ≠êÁî∫">ÁôΩÂ≠êÁî∫</option>
            </select>
            <div class="header-ctrl-area">
                 <button id="editBtn" class="btn-ctrl" onclick="toggleEditMode()">EDIT</button>
                 <button id="resetBtn" class="btn-ctrl" onclick="secureReset()" disabled>RESET</button>
            </div>
        </div>

        <div class="round-title">ROUND 01</div>
        <div class="player-inputs">
            <div class="input-group"><label>I</label><select id="r1_p1" class="player-select" onchange="updateSchedule('r1')" disabled></select></div>
            <div class="input-group"><label>II</label><select id="r1_p2" class="player-select" onchange="updateSchedule('r1')" disabled></select></div>
            <div class="input-group"><label>III</label><select id="r1_p3" class="player-select" onchange="updateSchedule('r1')" disabled></select></div>
            <div class="input-group"><label>IV</label><select id="r1_p4" class="player-select" onchange="updateSchedule('r1')" disabled></select></div>
            <div class="input-group"><label>V</label><select id="r1_p5" class="player-select" onchange="updateSchedule('r1')" disabled></select></div>
        </div>
        <table class="input-match-table">
            <thead><tr><th>No.</th><th>PAIR A</th><th>G</th><th></th><th>G</th><th>PAIR B</th><th>REST</th></tr></thead>
            <tbody id="r1_matchTableBody"></tbody>
        </table>
        <div style="text-align: center;" class="ranking-area"><h3>RANKING // 1st Phase</h3></div>
        <table class="standard-table">
            <thead><tr><th>#</th><th>NAME</th><th>WIN</th><th>RATE</th><th>G</th></tr></thead>
            <tbody id="r1_rankingTableBody"></tbody>
        </table>

        <div class="round-title">ROUND 02</div>
        <div class="player-inputs">
            <div class="input-group"><label>I</label><select id="r2_p1" class="player-select" onchange="updateSchedule('r2')" disabled></select></div>
            <div class="input-group"><label>II</label><select id="r2_p2" class="player-select" onchange="updateSchedule('r2')" disabled></select></div>
            <div class="input-group"><label>III</label><select id="r2_p3" class="player-select" onchange="updateSchedule('r2')" disabled></select></div>
            <div class="input-group"><label>IV</label><select id="r2_p4" class="player-select" onchange="updateSchedule('r2')" disabled></select></div>
            <div class="input-group"><label>V</label><select id="r2_p5" class="player-select" onchange="updateSchedule('r2')" disabled></select></div>
        </div>
        <table class="input-match-table">
            <thead><tr><th>No.</th><th>PAIR A</th><th>G</th><th></th><th>G</th><th>PAIR B</th><th>REST</th></tr></thead>
            <tbody id="r2_matchTableBody"></tbody>
        </table>
        <div style="text-align: center;" class="ranking-area"><h3>RANKING // 2nd Phase</h3></div>
        <table class="standard-table">
            <thead><tr><th>#</th><th>NAME</th><th>WIN</th><th>RATE</th><th>G</th></tr></thead>
            <tbody id="r2_rankingTableBody"></tbody>
        </table>

        <div style="text-align: center; margin-top:30px;" class="ranking-area"><h3 style="color:#fff;">TOTAL RANKING (TODAY)</h3></div>
        <table class="standard-table">
            <thead><tr><th>#</th><th>NAME</th><th>WIN</th><th>RATE</th><th>G</th></tr></thead>
            <tbody id="total_input_rankingTableBody"></tbody>
        </table>

        <button id="sendButton" class="btn-send" onclick="sendToSpreadsheet()" disabled>TRANSMIT DATA</button>
    </div>

    <div id="view-dashboard" class="view-section">
        <div class="section-title">Ê¥ªÂãïÁä∂Ê≥Å„Çµ„Éû„É™„Éº</div>
        <div class="dashboard-grid">
            <div class="stat-card"><div class="stat-label">ÈñãÂÇ¨ÂõûÊï∞</div><div class="stat-value highlight" id="totalMissions">0</div></div>
            <div class="stat-card"><div class="stat-label">Á∑è„Ç≤„Éº„É†Êï∞</div><div class="stat-value" id="totalGames">0</div></div>
            <div class="stat-card"><div class="stat-label">Âπ≥Âùá„Ç≤„Éº„É†</div><div class="stat-value" id="avgGames">-</div></div>
            <div class="stat-card"><div class="stat-label">ÊúÄÊñ∞MVP</div><div class="stat-value" id="latestMvp">-</div></div>
        </div>
        <div class="section-title">ÂãùÁéáÂàÜÊûê (TOP 5)</div>
        <div class="chart-container">
            <canvas id="winRateChart"></canvas>
        </div>
        <div class="section-title" style="margin-top:40px;">ÂØæÊà¶Â±•Ê≠¥„É≠„Ç∞</div>
        <div id="logsContainer"></div>
    </div>

    <div id="view-ranking" class="view-section">
        <div class="section-title">ÈÄöÁÆóÂÄã‰∫∫„É©„É≥„Ç≠„É≥„Ç∞</div>
        
        <div class="sector-filter-area" style="text-align:center; margin-bottom:20px;">
            <select id="sectorSelect" class="sector-select" onchange="filterRanking(this.value)">
                <option value="ALL">ALL SECTORS</option>
                <option value="Á∑¥È¶¨„Çπ„ÉÜ„ÉÉ„Éó„Ç§„É≥">Á∑¥È¶¨</option>
                <option value="ÁôæËçâ„ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥">ÁôæËçâ</option>
                <option value="„É¢„É™„Éë„Éº„ÇØ „ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥">„É¢„É™„Éë„Éº„ÇØ</option>
                <option value="ÁôΩÂ≠êÁî∫">ÁôΩÂ≠êÁî∫</option>
            </select>
        </div>

        <div style="text-align:center; font-size:0.7rem; color:#888; margin-bottom:10px;">Ë°å„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë©≥Á¥∞„ÇíË°®Á§∫</div>
        <table>
            <thead><tr><th>È†Ü‰Ωç</th><th>ÂêçÂâç</th><th>ÂãùÂà©Êï∞</th><th>ÂãùÁéá</th><th>MVP</th></tr></thead>
            <tbody id="leaderboardBody"></tbody>
        </table>
        <div class="medal-legend">
            <span>üëë ÊúÄÈ´òÂãùÁéá</span> <span>üî• ÂãùÁéá70%‚Üë</span> <span>üí™üèº ÊúÄÂ§öË©¶Âêà</span> <span>‚≠ê MVP</span><br>
            <span>üéØ ÂÆåÂ∞ÅÊúÄÂ§ö</span> <span>‚ù§Ô∏è‚Äçüî• Êé•Êà¶ÂãùÁéáNo.1</span>
        </div>
        <div class="rank-legend">
            <span>üåë ÂÄôË£úÁîü (0~)</span> <span>üõ∏ „Éë„Ç§„É≠„ÉÉ„Éà (100~)</span> <span>üõ∞Ô∏è Â£´ÂÆò (300~)</span><br>
            <span>üöÄ ÊåáÊèÆÂÆò (600~)</span> <span>ü™ê Ëâ¶Èï∑ (1000~)</span> <span>üåå ÊèêÁù£ (2000~)</span>
        </div>

        <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <div class="section-title">ÊúÄÂº∑„Éö„Ç¢„É©„É≥„Ç≠„É≥„Ç∞</div>
            <div style="text-align:center; font-size:0.7rem; color:#666; margin-bottom:10px;">‚Äª2Ë©¶Âêà‰ª•‰∏äÁµÑ„Çì„Å†„Éö„Ç¢„ÅÆ„ÅøÂØæË±°</div>
            <table class="standard-table">
                <thead><tr><th>È†Ü‰Ωç</th><th>„Éö„Ç¢</th><th>ÂãùÊïó</th><th>ÂãùÁéá</th></tr></thead>
                <tbody id="pairRankingBody"></tbody>
            </table>
        </div>
    </div>

    <div id="view-map" class="view-section">
        <div class="section-title">COURT NAVIGATION</div>
        <div class="sector-filter-area" style="text-align:center; margin-bottom:20px;">
            <select id="mapSectorSelect" class="sector-select" onchange="renderMapInfo(this.value)">
                <option value="-">SELECT SECTOR</option>
                <option value="MOGUSA">ÁôæËçâ„ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥</option>
            </select>
        </div>
        <div id="mapContainer">
            <div class="empty-map-state">
                <div class="spinning" style="display:inline-block; margin-bottom:10px;">‚ùñ</div><br>
                WAITING FOR NAVI INPUT...
            </div>
        </div>
    </div>

    <div id="view-learn" class="view-section">
        <div class="section-title">TACTICAL ARCHIVES</div>
        <div class="sector-filter-area" style="text-align:center; margin-bottom:20px;">
            <select id="learnCategorySelect" class="sector-select" onchange="renderVideos(this.value)">
                <option value="ALL">ALL</option>
                <option value="SERVE">SERVE</option>
                <option value="STROKE">STROKE</option>
                <option value="VOLLEY">VOLLEY</option>
                <option value="TACTICS">TACTICS</option>
            </select>
        </div>
        <div id="videoGrid" class="video-grid"></div>
    </div>

</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchMainView('match')"><span class="nav-icon">üéæ</span>INPUT</button>
    <button class="nav-item" onclick="switchMainView('dashboard')"><span class="nav-icon">üìà</span>TOP</button>
    <button class="nav-item" onclick="switchMainView('ranking')"><span class="nav-icon">üëë</span>RANK</button>
    <button class="nav-item" onclick="switchMainView('map')"><span class="nav-icon">üó∫Ô∏è</span>MAP</button>
    <button class="nav-item" onclick="switchMainView('learn')"><span class="nav-icon">üß†</span>LEARN</button>
</nav>

<div id="playerModal" onclick="closeModal(event)">
    <div class="modal-content">
        <button class="close-btn" onclick="closeModal(event)">√ó</button>
        <div class="modal-title" id="modalPlayerName"></div>
        <div id="rankInfoArea" class="rank-info-area"></div>
        <div class="modal-medals" id="modalMedals"></div>
        <div class="section-title" style="font-size:0.9rem;">ËÉΩÂäõ„ÉÅ„É£„Éº„Éà</div>
        <div class="chart-container" style="height:200px; margin-bottom:15px;">
            <canvas id="radarChart"></canvas>
        </div>
        <div class="section-title" style="font-size:0.9rem;">ÂãùÁéáÊé®Áßª</div>
        <div class="chart-container" style="height:150px; margin-bottom:0;">
            <canvas id="historyChart"></canvas>
        </div>
    </div>
</div>

<div id="videoModal" onclick="closeVideoModal(event)">
    <div class="video-container">
        <div id="videoPlayer"></div>
    </div>
</div>

<div id="toast"></div>

<script>
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzoybbIaxOq4EtWaBkvdPNzkN1_7lmFRnAQLbnu6A40YUQdbzX6gTfIY5CznZs13GYxZw/exec";
    const members = ["Âë®Âπ≥", "„Åô„Åå", "ÂáåÁü¢", "Á•ê‰ªã", "ÂøóÊùë", "Âä†Áôª", "Â∞èÁî∞"];
    const STORAGE_KEY = 'tennis_match_data_v7_holo';
    const CREW_RANKS = [
        { name: 'ÂÄôË£úÁîü',     min: 0,   icon: 'üåë' },
        { name: '„Éë„Ç§„É≠„ÉÉ„Éà', min: 100,  icon: 'üõ∏' },
        { name: 'Â£´ÂÆò',       min: 300,  icon: 'üõ∞Ô∏è' },
        { name: 'ÊåáÊèÆÂÆò',     min: 600,  icon: 'üöÄ' },
        { name: 'Ëâ¶Èï∑',       min: 1000, icon: 'ü™ê' },
        { name: 'ÊèêÁù£',       min: 2000, icon: 'üåå' }
    ];

    // „Äê‰øÆÊ≠£ 18„Äë Training Videos Data (Samples deleted, User ID added, titles modified)
    const trainingVideos = [
        { id: "IPfPjZyKzK4", cat: "SERVE", title: "Âàá„Çã„Çµ„Éº„Éñ„ÅÆÊâì„Å°Êñπ", desc: "ÂõûËª¢„Çí„Åã„Åë„Çã„Åü„ÇÅ„ÅÆ„Ç∞„É™„ÉÉ„Éó„Å®„Çπ„Ç§„É≥„Ç∞" },
        { id: "XotQwO2eLjM", cat: "STROKE", title: "„Çπ„Éà„É≠„Éº„ÇØ„ÅÆË∫´‰ΩìÊìç‰Ωú", desc: "ËÖ∞„ÅÆÂõûËª¢„Çà„ÇäÈáçË¶Å„Å™ËÜù„ÅÆ‰Ωø„ÅÑÊñπ" },
        { id: "_xhTeqqF80U", cat: "VOLLEY", title: "„Éú„É¨„Éº„ÅÆÂü∫Êú¨ÂßøÂã¢", desc: "„É©„Ç±„ÉÉ„Éà„Çª„ÉÉ„Éà„Å®Ë∂≥„ÅÆÈÅã„Å≥" },
        { id: "4tuxGRkZAnk", cat: "STROKE", title: "„Éê„ÉÉ„ÇØ„Éè„É≥„Éâ„ÅÆÂü∫Êú¨", desc: "ÂÆâÂÆö„Åô„ÇãÊâìÁÇπ„Å®Ë∫´‰Ωì„ÅÆÂêë„Åç" },
        { id: "qXhtrKC8gjA", cat: "STROKE", title: "ËÇ©Áî≤È™®„Çπ„Éà„É≠„Éº„ÇØ", desc: "ÂèØÂãïÂüü„Çí‰Ωø„Å£„ÅüÂº∑Âäõ„Å™ÊâìÁêÉ" },
        { id: "kSsq_s1OoB8", cat: "SERVE", title: "ÈÄü„ÅÑ„Çµ„Éº„Éñ„ÅÆ„Ç≥„ÉÑ", desc: "Â∞èÊüÑ„Å™ÈÅ∏Êâã„Åß„ÇÇ‰Ωø„Åà„ÇãË∫´‰ΩìÊìç‰Ωú" },
        { id: "66Pky_Ogyl0", cat: "TACTICS", title: "„Éù„Éº„ÉÅ„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞", desc: "ÂâçË°õ„ÅÆÈ£õ„Å≥Âá∫„ÅóÂà§Êñ≠„Å®Âãï„Åç" },
        { id: "J-xSKZRI9kI", cat: "SERVE", title: "Â§âÂåñ„Åô„Çã„Ç´„ÉÉ„Éà„Çµ„Éº„Éñ", desc: "„Éú„Éº„É´„ÅÆÂàá„ÇäÊñπ„Å®„É©„Ç±„ÉÉ„Éà„ÉØ„Éº„ÇØ" },
        { id: "HOwBO9yljQ4", cat: "STROKE", title: "‰π±Êâì„ÇíÁ∂ö„Åë„Çã„Ç≥„ÉÑ", desc: "„Éü„Çπ„ÅÆÂéüÂõ†„Å®‰øÆÊ≠£„Éù„Ç§„É≥„Éà" },
        { id: "-8pVUELG1gE", cat: "STROKE", title: "„Éê„ÉÉ„ÇØ„Éè„É≥„Éâ„ÅÆÈ£õË∑ùÈõ¢", desc: "È£õ„Å∞„Å™„ÅÑÂéüÂõ†„Å®ÊîπÂñÑ„Éâ„É™„É´" },
        { id: "mfDwhROR3H8", cat: "VOLLEY", title: "„Çπ„Éû„ÉÉ„Ç∑„É•„ÅÆÂü∫Êú¨", desc: "ËêΩ‰∏ãÂú∞ÁÇπ„Å∏„ÅÆÂÖ•„ÇäÊñπ„Å®„Ç§„É≥„Éë„ÇØ„Éà" }
    ];

    let isEditMode = false;
    let isLoading = false;
    let playerStatsGlobal = {};
    let radarChartInstance = null;
    let historyChartInstance = null;
    let winRateChartInstance = null;
    
    let rawAnalysisRankings = [];
    let rawAnalysisMatches = [];
    let currentSector = 'ALL';

    window.onload = function() {
        initSelectors();
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('matchDate').textContent = `${yyyy}-${mm}-${dd}`;
        fetchAnalysisData();
        renderVideos('ALL'); // Initial render for Learn page
        setTimeout(() => {
            document.getElementById('loadingScreen').style.opacity = 0;
            setTimeout(() => { document.getElementById('loadingScreen').style.display = 'none'; }, 800);
        }, 1000);
    };

    function switchMainView(viewName) {
        document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
        const navs = document.querySelectorAll('.nav-item');
        // Nav Mapping: INPUT(0), TOP(1), RANK(2), MAP(3), LEARN(4)
        if(viewName === 'match') navs[0].classList.add('active');
        if(viewName === 'dashboard') navs[1].classList.add('active');
        if(viewName === 'ranking') navs[2].classList.add('active');
        if(viewName === 'map') navs[3].classList.add('active');
        if(viewName === 'learn') navs[4].classList.add('active');
        
        document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        const titles = { 'match': 'MATCH INPUT', 'dashboard': 'DASHBOARD', 'ranking': 'RANKING', 'map': 'COURT MAP', 'learn': 'TACTICAL ARCHIVES' };
        document.getElementById('pageTitle').textContent = titles[viewName] || 'TENNIS CHRONICLES';
    }

    // ================== MAP LOGIC (NEW: CODE 23) ==================
    const courtDatabase = {
        "MOGUSA": {
            name: "ÁôæËçâ„ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥",
            address: "„Äí191-0033 Êù±‰∫¨ÈÉΩÊó•ÈáéÂ∏ÇÁôæËçâ878‚àí1",
            tel: "042-591-1212",
            hours: "9:00ÔΩû18:00",
            // Standard Google Maps Embed for search query "ÁôæËçâ„ÉÜ„Éã„Çπ„Ç¨„Éº„Éá„É≥"
            mapSrc: "https://maps.google.com/maps?q=%E7%99%BE%E8%8D%89%E3%83%86%E3%83%8B%E3%82%B9%E3%82%AC%E3%83%87%E3%83%B3&t=&z=15&ie=UTF8&iwloc=&output=embed"
        }
    };

    function renderMapInfo(val) {
        const c = document.getElementById('mapContainer');
        const data = courtDatabase[val];

        if (!data) {
            c.innerHTML = `
            <div class="empty-map-state">
                <div class="spinning" style="display:inline-block; margin-bottom:10px;">‚ùñ</div><br>
                WAITING FOR NAVI INPUT...
            </div>`;
            return;
        }

        const displayAddress = "„Äí191-0033<br>Êù±‰∫¨ÈÉΩÊó•ÈáéÂ∏ÇÁôæËçâ878‚àí1";

        c.innerHTML = `
            <div class="map-frame">
                <iframe src="${data.mapSrc}" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"></iframe>
            </div>
            <div class="info-card">
                <div class="info-row"><div class="info-label">SECTOR</div><div class="info-val" style="color:#00ffff; font-weight:bold;">${data.name}</div></div>
                <div class="info-row">
                    <div class="info-label">ADDRESS</div>
                    <div class="info-val">
                        ${displayAddress}
                        <button onclick="copyToClipboard('${data.address}')" style="background:rgba(0,255,255,0.1); border:1px solid #00ffff; color:#00ffff; border-radius:4px; cursor:pointer; margin-left:10px; padding:2px 6px; font-size:0.7rem;">üìã</button>
                    </div>
                </div>
                <div class="info-row"><div class="info-label">TEL</div><div class="info-val"><a href="tel:${data.tel}" style="color:#fff;text-decoration:none;">${data.tel}</a></div></div>
                <div class="info-row"><div class="info-label">HOURS</div><div class="info-val">${data.hours}</div></div>
                <div class="info-row"><div class="info-label">COST</div><div class="info-val">¬•4,500/h</div></div>

                <div style="margin-top:15px; padding-top:15px; border-top:1px dashed rgba(255,255,255,0.2);">
                    <div style="font-size:0.75rem; color:#00ffff; margin-bottom:5px; letter-spacing:1px;">SPLIT CALCULATOR</div>
                    <div style="display:flex; align-items:center; gap:8px; font-size:0.9rem;">
                        COST √ó 
                        <select id="calcHours" onchange="calcSplit()" style="background:rgba(0,0,0,0.5); color:#fff; border:1px solid #555; padding:4px; border-radius:4px;">
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                        </select>
                        √∑ 
                        <select id="calcMembers" onchange="calcSplit()" style="background:rgba(0,0,0,0.5); color:#fff; border:1px solid #555; padding:4px; border-radius:4px;">
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                        = <span id="calcResult" style="color:#00ffff; font-weight:bold; font-size:1.1rem; margin-left:5px;">¬•3,375</span>
                    </div>
                </div>
            </div>
        `;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast("ADDRESS COPIED");
        });
    }

    function calcSplit() {
        const cost = 4500;
        const members = parseInt(document.getElementById('calcMembers').value);
        const hours = parseInt(document.getElementById('calcHours').value);
        const result = Math.ceil((cost * hours) / members);
        document.getElementById('calcResult').innerText = '¬•' + result.toLocaleString();
    }

    // ================== LEARN PAGE LOGIC (UPDATED: Option A - Modal Play with fixed sizing) ==================
    function renderVideos(category) {
        const grid = document.getElementById('videoGrid');
        grid.innerHTML = "";
        const filtered = category === 'ALL' ? trainingVideos : trainingVideos.filter(v => v.cat === category);
        
        filtered.forEach(v => {
            const card = document.createElement('div');
            card.className = 'video-card';
            // „Äê‰øÆÊ≠£ 15„Äë Revert to playVideo (Modal)
            card.onclick = function() { playVideo(v.id); };
            
            const thumbUrl = `https://img.youtube.com/vi/${v.id}/mqdefault.jpg`;
            
            // „Äê‰øÆÊ≠£ 19„Äë Option B Design (Glass) - Play icon updated
            card.innerHTML = `
                <div class="video-thumb" style="background-image: url('${thumbUrl}');">
                    <div class="video-overlay"><div class="video-play-icon">‚ñ∂</div></div>
                </div>
                <div class="video-info">
                    <div class="video-meta"><span>${v.cat}</span></div>
                    <div class="video-title">${v.title}</div>
                    <div style="font-size:0.7rem; color:#aaa;">${v.desc}</div>
                </div>`;
            grid.appendChild(card);
        });
    }

    // „Äê‰øÆÊ≠£ 15„Äë Option A: Modal Player Logic
    function playVideo(id) {
        const modal = document.getElementById('videoModal');
        const player = document.getElementById('videoPlayer');
        // Autoplay enabled
        player.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
        modal.style.display = 'flex';
    }

    function closeVideoModal(e) {
        // Close if clicked on background or explicitly called
        if(e.target.id === 'videoModal') {
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('videoPlayer').innerHTML = ''; // Stop video by removing iframe
        }
    }

    // ================== INPUT LOGIC ==================
    const patterns = [[1, 2, 3, 4, 5],[1, 5, 2, 3, 4],[1, 4, 2, 5, 3],[1, 3, 4, 5, 2],[2, 4, 3, 5, 1]];

    function initSelectors() {
        ['r1', 'r2'].forEach(r => {
            [1,2,3,4,5].forEach(i => {
                const el = document.getElementById(`${r}_p${i}`);
                if(!el) return;
                const def = document.createElement("option"); def.value = "-"; def.text = "-"; el.appendChild(def);
                members.forEach(m => { const op = document.createElement("option"); op.value = m; op.text = m; el.appendChild(op); });
                el.value = "-";
            });
        });
        if (!loadState()) { updateSchedule('r1'); updateSchedule('r2'); }
    }

    function toggleEditMode() {
        if (!isEditMode) {
            const pin = prompt("ENTER PASSCODE");
            if (pin === "8047") { isEditMode = true; applyEditMode(); showToast("UNLOCKED"); }
            else if (pin !== null) { alert("ACCESS DENIED"); }
        } else { isEditMode = false; applyEditMode(); showToast("LOCKED"); }
    }

    function applyEditMode() {
        const btn = document.getElementById('editBtn');
        const resetBtn = document.getElementById('resetBtn'); 
        const inputs = document.querySelectorAll('select.player-select, select#courtSelect');
        const scores = document.querySelectorAll('select.score-select');
        const sendBtn = document.getElementById('sendButton');

        if (isEditMode) {
            btn.textContent = "LOCK"; btn.classList.add("unlocked"); resetBtn.disabled = false; 
            inputs.forEach(el => el.disabled = false); scores.forEach(el => el.disabled = false);
            if(sendBtn) sendBtn.disabled = false;
        } else {
            btn.textContent = "EDIT"; btn.classList.remove("unlocked"); resetBtn.disabled = true; 
            inputs.forEach(el => el.disabled = true); scores.forEach(el => el.disabled = true);
            if(sendBtn) sendBtn.disabled = true;
        }
    }

    function createScoreSelect() {
        const s = document.createElement("select"); s.className = "score-select"; s.disabled = !isEditMode;
        const d = document.createElement("option"); d.value = "-"; d.text = "-"; s.appendChild(d);
        for (let i = 0; i <= 4; i++) { const o = document.createElement("option"); o.value = i; o.text = i; s.appendChild(o); }
        return s;
    }

    function startCoinToss() {
        const c = document.getElementById('coin');
        // Removed button reference
        c.classList.add('spinning');
        setTimeout(() => { c.classList.remove('spinning'); c.textContent = Math.random() < 0.5 ? "HEAD" : "TAIL"; }, 1500);
    }

    function secureReset() {
        if (!isEditMode) return;
        if (confirm("RESET INPUT?")) {
            document.querySelectorAll('.player-select').forEach(s => s.value = "-");
            document.querySelectorAll('.score-select').forEach(s => s.value = "-"); 
            document.getElementById('courtSelect').value = "-";
            localStorage.removeItem(STORAGE_KEY);
            updateSchedule('r1'); updateSchedule('r2');
            showToast("RESET DONE");
        }
    }

    function updatePlayerOptions(rp) {
        const selects = []; for(let i=1; i<=5; i++) selects.push(document.getElementById(`${rp}_p${i}`));
        const vals = selects.map(s => s.value).filter(v => v !== "-");
        selects.forEach(s => {
            s.querySelectorAll('option').forEach(o => {
                if (o.value === "-") return;
                o.disabled = (vals.includes(o.value) && s.value !== o.value);
            });
        });
    }

    function checkWinner(sA, sB, cTA, cSA, cSB, cTB, rp) {
        const vA = sA.value; const vB = sB.value;
        if (vA !== "-") sA.classList.add("filled"); else sA.classList.remove("filled");
        if (vB !== "-") sB.classList.add("filled"); else sB.classList.remove("filled");
        [cTA, cSA, cSB, cTB].forEach(c => c.classList.remove("winner", "loser"));
        if (vA !== "-" && vB !== "-") {
            const iA = parseInt(vA); const iB = parseInt(vB);
            if (iA > iB) { cTA.classList.add("winner"); cSA.classList.add("winner"); cTB.classList.add("loser"); cSB.classList.add("loser"); }
            else if (iB > iA) { cTB.classList.add("winner"); cSB.classList.add("winner"); cTA.classList.add("loser"); cSA.classList.add("loser"); }
        }
        updateInputRanking(rp); saveState();
    }

    function updateSchedule(rp) {
        const p = {}; for(let i=1; i<=5; i++) p[i] = document.getElementById(`${rp}_p${i}`).value;
        updatePlayerOptions(rp);
        const pl = {1:p[1], 2:p[2], 3:p[3], 4:p[4], 5:p[5]};
        
        const currentScores = [];
        const oldTbody = document.getElementById(`${rp}_matchTableBody`);
        if (oldTbody) {
            for (let i = 0; i < oldTbody.rows.length; i++) {
                const sA = oldTbody.rows[i].querySelector('select[data-type="scoreA"]');
                const sB = oldTbody.rows[i].querySelector('select[data-type="scoreB"]');
                currentScores.push({
                    a: sA ? sA.value : "-",
                    b: sB ? sB.value : "-"
                });
            }
        }

        const tb = document.getElementById(`${rp}_matchTableBody`); tb.innerHTML = "";
        patterns.forEach((pat, idx) => {
            const row = document.createElement("tr");
            row.dataset.pA1=pl[pat[0]]; row.dataset.pA2=pl[pat[1]]; row.dataset.pB1=pl[pat[2]]; row.dataset.pB2=pl[pat[3]];
            
            // --- „Çπ„Éû„Éõ„É™„Çπ„ÉàÂûã„É¨„Ç§„Ç¢„Ç¶„ÉàÂØæÂøú ---
            const cNo = document.createElement("td"); cNo.textContent=`MATCH ${idx+1}`; row.appendChild(cNo);
            
            // „Éö„Ç¢A
            const cTA = document.createElement("td"); cTA.textContent=`${pl[pat[0]]} & ${pl[pat[1]]}`; row.appendChild(cTA);
            
            // „Çπ„Ç≥„Ç¢A
            const cSA = document.createElement("td"); cSA.className="score-cell";
            const sA = createScoreSelect(); sA.setAttribute('data-type','scoreA'); 
            if(currentScores[idx]) sA.value = currentScores[idx].a;
            cSA.appendChild(sA); row.appendChild(cSA);
            
            const probA = getWinProbability(pl[pat[0]], pl[pat[1]]);
            const cVs = document.createElement("td"); cVs.className="vs"; 
            cVs.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; width:100%;">
                    <div style="font-size:0.6rem; color:#aaa; margin-bottom:2px;">WIN PROBABILITY</div>
                    <div style="display:flex; width:80%; height:4px; background:#333; border-radius:2px; overflow:hidden;">
                        <div style="width:${probA}%; background:#00ffff; box-shadow:0 0 5px #00ffff;"></div>
                        <div style="width:${100-probA}%; background:#555;"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; width:80%; font-size:0.6rem; margin-top:2px;">
                        <span style="color:#00ffff;">${probA}%</span>
                        <span style="color:#888;">${100-probA}%</span>
                    </div>
                </div>`;
            row.appendChild(cVs);
            
            // „Çπ„Ç≥„Ç¢B
            const cSB = document.createElement("td"); cSB.className="score-cell";
            const sB = createScoreSelect(); sB.setAttribute('data-type','scoreB'); 
            if(currentScores[idx]) sB.value = currentScores[idx].b;
            cSB.appendChild(sB); row.appendChild(cSB);
            
            // „Éö„Ç¢B
            const cTB = document.createElement("td"); cTB.textContent=`${pl[pat[2]]} & ${pl[pat[3]]}`; row.appendChild(cTB);
            
            // REST
            const cR = document.createElement("td"); cR.className="rest-highlight"; cR.textContent=pl[pat[4]]; row.appendChild(cR);
            
            sA.onchange = () => checkWinner(sA, sB, cTA, cSA, cSB, cTB, rp);
            sB.onchange = () => checkWinner(sA, sB, cTA, cSA, cSB, cTB, rp);
            tb.appendChild(row);
            checkWinner(sA, sB, cTA, cSA, cSB, cTB, rp);
        });
        updateInputRanking(rp); saveState();
    }

    function calculateStats(rp) {
        const p={}; for(let i=1;i<=5;i++) p[i]=document.getElementById(`${rp}_p${i}`).value;
        let st={}; [p[1],p[2],p[3],p[4],p[5]].forEach(n=>{if(n!=="-") st[n]={wins:0,losses:0,games:0}});
        const rows = document.getElementById(`${rp}_matchTableBody`).rows;
        for(let row of rows) {
            const sA=row.querySelector('select[data-type="scoreA"]').value;
            const sB=row.querySelector('select[data-type="scoreB"]').value;
            if(sA!=="-" && sB!=="-"){
                const iA=parseInt(sA), iB=parseInt(sB);
                [row.dataset.pA1, row.dataset.pA2].forEach(n=>{if(st[n]) st[n].games+=iA});
                [row.dataset.pB1, row.dataset.pB2].forEach(n=>{if(st[n]) st[n].games+=iB});
                if(iA>iB){ [row.dataset.pA1, row.dataset.pA2].forEach(n=>{if(st[n]) st[n].wins++}); [row.dataset.pB1, row.dataset.pB2].forEach(n=>{if(st[n]) st[n].losses++}); }
                else if(iB>iA){ [row.dataset.pB1, row.dataset.pB2].forEach(n=>{if(st[n]) st[n].wins++}); [row.dataset.pA1, row.dataset.pA2].forEach(n=>{if(st[n]) st[n].losses++}); }
            }
        }
        return st;
    }

    function updateInputRanking(rp) {
        const st = calculateStats(rp);
        const pl = Object.keys(st).sort((a,b)=>{
            const rA=(st[a].wins+st[a].losses)>0 ? st[a].wins/(st[a].wins+st[a].losses) : 0;
            const rB=(st[b].wins+st[b].losses)>0 ? st[b].wins/(st[b].wins+st[b].losses) : 0;
            if(rB!==rA) return rB-rA;
            if(st[b].wins!==st[a].wins) return st[b].wins-st[a].wins;
            return st[b].games-st[a].games;
        });
        const tb=document.getElementById(`${rp}_rankingTableBody`); tb.innerHTML="";
        pl.forEach((n,i)=>{
            const tr=document.createElement("tr");
            const tot=st[n].wins+st[n].losses;
            const rate=tot>0 ? ((st[n].wins/tot)*100).toFixed(0)+"%" : "-";
            tr.innerHTML=`<td class="${i===0?'rank-1':''}">${i+1}</td><td>${n}</td><td>${st[n].wins}-${st[n].losses}</td><td>${rate}</td><td>${st[n].games}</td>`;
            tb.appendChild(tr);
        });
        updateInputTotalRanking();
    }

    function updateInputTotalRanking() {
        const s1 = calculateStats('r1');
        const s2 = calculateStats('r2');
        let total = {};
        const allP = new Set([...Object.keys(s1), ...Object.keys(s2)]);
        allP.forEach(n => { total[n] = {wins:0, losses:0, games:0}; });
        [s1, s2].forEach(s => { for(let n in s) { total[n].wins += s[n].wins; total[n].losses += s[n].losses; total[n].games += s[n].games; } });
        const sorted = Array.from(allP).sort((a,b)=>{
            const rA=(total[a].wins+total[a].losses)>0 ? total[a].wins/(total[a].wins+total[a].losses) : 0;
            const rB=(total[b].wins+total[b].losses)>0 ? total[b].wins/(total[b].wins+total[b].losses) : 0;
            if(rB!==rA) return rB-rA;
            if(total[b].wins!==total[a].wins) return total[b].wins-total[a].wins;
            return total[b].games-total[a].games;
        });
        const tb=document.getElementById('total_input_rankingTableBody'); tb.innerHTML="";
        sorted.forEach((n,i)=>{
            const tr=document.createElement("tr");
            const tot=total[n].wins+total[n].losses;
            const rate=tot>0 ? ((total[n].wins/tot)*100).toFixed(0)+"%" : "-";
            tr.innerHTML=`<td class="${i===0?'rank-1':''}">${i+1}</td><td>${n}</td><td>${total[n].wins}-${total[n].losses}</td><td>${rate}</td><td>${total[n].games}</td>`;
            tb.appendChild(tr);
        });
    }

    function saveState() {
        if(isLoading) return;
        const court = document.getElementById('courtSelect').value;
        const rd = {};
        ['r1','r2'].forEach(r => {
            const pl={}; for(let i=1;i<=5;i++) pl[`p${i}`]=document.getElementById(`${r}_p${i}`).value;
            const sc=[]; const rows=document.getElementById(`${r}_matchTableBody`).rows;
            for(let row of rows) { sc.push({a:row.querySelector('select[data-type="scoreA"]').value, b:row.querySelector('select[data-type="scoreB"]').value}); }
            rd[r]={players:pl, scores:sc};
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify({meta:{court}, rounds:rd}));
    }

    function loadState() {
        const json = localStorage.getItem(STORAGE_KEY); if(!json) return false;
        try {
            isLoading = true;
            const data=JSON.parse(json);
            if(data.meta && data.meta.court) document.getElementById('courtSelect').value=data.meta.court;
            ['r1','r2'].forEach(r => {
                if(data.rounds && data.rounds[r]) {
                    const rd=data.rounds[r];
                    for(let i=1;i<=5;i++) document.getElementById(`${r}_p${i}`).value=rd.players[`p${i}`];
                    updateSchedule(r); 
                    const rows=document.getElementById(`${r}_matchTableBody`).rows;
                    rd.scores.forEach((s, idx)=>{
                        if(rows[idx]) {
                            const sA=rows[idx].querySelector('select[data-type="scoreA"]');
                            const sB=rows[idx].querySelector('select[data-type="scoreB"]');
                            sA.value=s.a; sB.value=s.b;
                            const cTA = rows[idx].cells[1]; const cSA = rows[idx].cells[2];
                            const cSB = rows[idx].cells[4]; const cTB = rows[idx].cells[5];
                            checkWinner(sA, sB, cTA, cSA, cSB, cTB, r);
                        }
                    });
                }
            });
            updatePlayerOptions('r1');
            updatePlayerOptions('r2');
            applyEditMode();
            isLoading = false;
            return true;
        } catch(e) { console.error(e); isLoading = false; return false; }
    }

    function sendToSpreadsheet() {
        if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes("„Åì„Åì„Å´")) { alert("GAS_WEB_APP_URL Error"); return; }
        const btn = document.getElementById('sendButton'); btn.disabled = true; btn.textContent = "SENDING...";
        const date = document.getElementById('matchDate').textContent;
        const court = document.getElementById('courtSelect').value === '-' ? '„Ç≥„Éº„ÉàÊú™ÂÆö' : document.getElementById('courtSelect').value;
        let rankings = [];
        ['r1', 'r2'].forEach(r => {
            const rows = document.getElementById(`${r}_rankingTableBody`).querySelectorAll('tr');
            const roundName = r==='r1' ? '1ÂõûÊà¶' : '2ÂõûÊà¶';
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length>0) {
                    const wl = cols[2].textContent.split('-');
                    rankings.push({
                        rank: cols[0].textContent, name: cols[1].textContent + ` (${roundName})`,
                        win: wl[0], lose: wl[1], rate: cols[3].textContent, games: cols[4].textContent
                    });
                }
            });
        });
        let matches = [];
        ['r1', 'r2'].forEach(r => {
            const rows = document.getElementById(`${r}_matchTableBody`).rows;
            for(let i=0; i<rows.length; i++) {
                const row = rows[i];
                if(row.dataset.pA1) {
                    const sA = row.querySelector('select[data-type="scoreA"]').value;
                    const sB = row.querySelector('select[data-type="scoreB"]').value;
                    if(sA!=="-" && sB!=="-") {
                        matches.push({
                            round: r==='r1'?1:2, no: i+1,
                            pA1: row.dataset.pA1, pA2: row.dataset.pA2, scoreA: sA, scoreB: sB,
                            pB1: row.dataset.pB1, pB2: row.dataset.pB2
                        });
                    }
                }
            }
        });
        if(rankings.length===0) { showToast("NO DATA"); btn.disabled=false; btn.textContent="TRANSMIT DATA"; return; }
        fetch(GAS_WEB_APP_URL, {
            method: 'POST', mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ date, court, rankings, matches })
        }).then(() => { showToast("SENT SUCCESSFULLY"); fetchAnalysisData(); })
        .catch(e => { console.error(e); showToast("FAILED"); })
        .finally(() => { 
            btn.textContent="TRANSMIT DATA"; 
            btn.disabled = !isEditMode;
        });
    }

    function showToast(msg) {
        const t=document.getElementById("toast"); t.textContent=msg; t.className="show";
        setTimeout(()=>{t.className=t.className.replace("show","")},3000);
    }

    // --- AI Logic ---
    function getPlayerWinRate(name) {
        if(!playerStatsGlobal || !playerStatsGlobal[name]) return 0.5; 
        const p = playerStatsGlobal[name];
        const total = p.wins + p.losses;
        return total > 0 ? p.wins / total : 0.5;
    }

    function getWinProbability(p1, p2) {
        if(p1 === "-" || p2 === "-") return 0;
        const r1 = getPlayerWinRate(p1);
        const r2 = getPlayerWinRate(p2);
        return Math.round(((r1 + r2) / 2) * 100);
    }

    // ================== ANALYSIS LOGIC ==================
    async function fetchAnalysisData() {
        if(GAS_WEB_APP_URL.includes("„Åì„Åì„Å´")) return;
        try {
            const res = await fetch(GAS_WEB_APP_URL);
            const json = await res.json();
            if(json.status === 'success') { 
                rawAnalysisRankings = json.rankings; 
                rawAnalysisMatches = json.matches;
                processAnalysisData(); 
            }
        } catch(e) { console.error(e); }
    }

    function filterRanking(sector) {
        currentSector = sector;
        // Select„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ†¥Âêà„ÅØactive„ÇØ„É©„Çπ„ÅÆÂàá„ÇäÊõø„Åà‰∏çË¶ÅÔºà„Éñ„É©„Ç¶„Ç∂Ê®ôÊ∫ñÔºâ
        processAnalysisData();
    }

    function processAnalysisData() {
        const rRows = rawAnalysisRankings.slice(1);
        let pStats = {}, mDates = new Set(), totalG = 0, logs = {};
        let max = { wins:0, games:0, mvpCount:0, matches:0, sniperCount:0, clutchWins:0, clutchTotal:0, bestWR:0, clutchR:0, sniper:0 };

        rRows.forEach(row => {
            if (!row[0] || !row[3]) return;
            const rawName = String(row[3]);
            if(rawName.includes("undefined") || rawName.trim() === "") return;

            const court = row[1];
            if (currentSector !== 'ALL' && court !== currentSector) return;

            const dObj = new Date(row[0]);
            const y = dObj.getFullYear();
            const m = ('0' + (dObj.getMonth() + 1)).slice(-2);
            const day = ('0' + dObj.getDate()).slice(-2);
            const d = `${y}-${m}-${day}`;

            const rk = row[2];
            const nm = rawName.split(' (')[0];
            const w = parseInt(row[4]), l = parseInt(row[5]), g = parseInt(row[7]);

            mDates.add(d); totalG += g;
            if(!pStats[nm]) pStats[nm] = {name:nm, wins:0, losses:0, games:0, mvpCount:0, matches:0, history:[], sniperCount:0, clutchWins:0, clutchTotal:0};
            pStats[nm].wins += w; pStats[nm].losses += l; pStats[nm].games += g; pStats[nm].matches += (w+l);
            if(rk==1) pStats[nm].mvpCount++;

            const rt = (pStats[nm].wins + pStats[nm].losses) > 0 ? pStats[nm].wins/(pStats[nm].wins+pStats[nm].losses)*100 : 0;
            const hLog = pStats[nm].history.find(h=>h.date===d);
            if(hLog) hLog.rate = rt; else pStats[nm].history.push({date:d, rate:rt});

            const k = `${d}_${court}`;
            if(!logs[k]) logs[k] = {date:d, court:court, records:[]};
            logs[k].records.push({ rank:rk, name:nm, win:w, lose:l, rate:row[6], games:g });
        });

        let pairStats = {};
        const mRows = rawAnalysisMatches ? rawAnalysisMatches.slice(1) : [];
        mRows.forEach(row => {
            const matchCourt = row[1];
            if (currentSector !== 'ALL' && matchCourt !== currentSector) return;

            const pA1=row[4], pA2=row[5], sA=parseInt(row[6]), sB=parseInt(row[7]), pB1=row[8], pB2=row[9];
            if(pA1==="-") return;
            const pairA = [pA1,pA2].sort().join(' & '); const pairB = [pB1,pB2].sort().join(' & ');
            if(!pairStats[pairA]) pairStats[pairA]={wins:0,losses:0,total:0}; if(!pairStats[pairB]) pairStats[pairB]={wins:0,losses:0,total:0};
            pairStats[pairA].total++; pairStats[pairB].total++;
            if(sA > sB) { pairStats[pairA].wins++; pairStats[pairB].losses++; }
            else if(sB > sA) { pairStats[pairB].wins++; pairStats[pairA].losses++; }

            if(sA===4 && sB===0) { if(pStats[pA1]) pStats[pA1].sniperCount++; if(pStats[pA2]) pStats[pA2].sniperCount++; }
            if(sA===0 && sB===4) { if(pStats[pB1]) pStats[pB1].sniperCount++; if(pStats[pB2]) pStats[pB2].sniperCount++; }
            if(Math.abs(sA-sB)===1) {
                [pA1,pA2,pB1,pB2].forEach(p=>{if(pStats[p]) pStats[p].clutchTotal++});
                if(sA>sB) { if(pStats[pA1]) pStats[pA1].clutchWins++; if(pStats[pA2]) pStats[pA2].clutchWins++; }
                else { if(pStats[pB1]) pStats[pB1].clutchWins++; if(pStats[pB2]) pStats[pB2].clutchWins++; }
            }
        });

        let maxWR = 0, maxSn = 0, maxCR = 0;
        Object.values(pStats).forEach(p => {
            if(p.wins>max.wins) max.wins=p.wins;
            if(p.games>max.games) max.games=p.games;
            if(p.mvpCount>max.mvpCount) max.mvpCount=p.mvpCount;
            if(p.matches>max.matches) max.matches=p.matches;
            if(p.sniperCount>maxSn) maxSn=p.sniperCount;
            const r = (p.wins+p.losses)>0 ? p.wins/(p.wins+p.losses) : 0;
            if(r>maxWR) maxWR=r;
            const cr = p.clutchTotal>0 ? p.clutchWins/p.clutchTotal : 0;
            if(cr>maxCR && p.clutchTotal>0) maxCR=cr;
        });
        max.sniper = maxSn; max.clutchR = maxCR; max.bestWR = maxWR;
        
        playerStatsGlobal = pStats;
        playerStatsGlobal._max = max;

        document.getElementById('totalMissions').textContent = mDates.size;
        document.getElementById('totalGames').textContent = totalG;
        const avg = mDates.size > 0 ? (totalG / mDates.size).toFixed(1) : "0";
        document.getElementById('avgGames').textContent = avg;

        const lastD = Array.from(mDates).sort().pop();
        if(lastD) {
            const todayLogs = logs[Object.keys(logs).find(k=>k.startsWith(lastD))];
            if(todayLogs) {
                let dS={}; todayLogs.records.forEach(r=>{ if(!dS[r.name])dS[r.name]=0; dS[r.name]+=parseInt(r.win); });
                const best = Object.entries(dS).sort((a,b)=>b[1]-a[1])[0];
                document.getElementById('latestMvp').textContent = best ? best[0] : '-';
            }
        }

        const sortedP = Object.values(pStats).sort((a,b)=>{
            const rA = (a.wins+a.losses)>0?a.wins/(a.wins+a.losses):0;
            const rB = (b.wins+b.losses)>0?b.wins/(b.wins+b.losses):0;
            if(rB!==rA) return rB-rA; return b.wins-a.wins;
        });

        renderAnalysisRanking(sortedP);
        renderAnalysisPairs(pairStats);
        renderAnalysisLogs(logs);
        renderAnalysisChart(sortedP);

        if(currentSector === 'ALL') { updateSchedule('r1'); updateSchedule('r2'); }
    }

    function getRankInfo(games) {
        for(let i=CREW_RANKS.length-1; i>=0; i--) { if(games>=CREW_RANKS[i].min) return {current:CREW_RANKS[i], next:CREW_RANKS[i+1]||null}; }
        return {current:CREW_RANKS[0], next:CREW_RANKS[1]};
    }

    function getMedals(p, m) {
        let h = "";
        const r = (p.wins+p.losses)>0 ? p.wins/(p.wins+p.losses) : 0;
        const cr = p.clutchTotal>0 ? p.clutchWins/p.clutchTotal : 0;
        if(r===m.bestWR && p.matches>0) h+='<span class="medal-icon">üëë</span>';
        if(r>=0.7 && p.matches>0) h+='<span class="medal-icon">üî•</span>';
        if(p.matches===m.matches && m.matches>0) h+='<span class="medal-icon">üí™üèº</span>';
        for(let i=0; i<Math.min(p.mvpCount,3); i++) h+='<span class="medal-icon">‚≠ê</span>';
        if(p.sniperCount===m.sniper && m.sniper>0) h+='<span class="medal-icon">üéØ</span>';
        if(cr===m.clutchR && m.clutchR>0 && p.clutchTotal>0) h+='<span class="medal-icon">‚ù§Ô∏è‚Äçüî•</span>';
        return h;
    }

    function renderAnalysisRanking(players) {
        const tb = document.getElementById('leaderboardBody'); tb.innerHTML="";
        players.forEach((p,i)=>{
            if (!p.name || p.name === "undefined") return;
            const tr = document.createElement('tr');
            const rate = (p.wins+p.losses)>0 ? ((p.wins/(p.wins+p.losses))*100).toFixed(1)+'%' : '-';
            const rk = getRankInfo(p.games).current;
            tr.onclick = () => showModal(p.name);
            tr.innerHTML = `<td class="${i===0?'rank-1':''}">${i+1}</td>
                <td style="text-align:left;padding-left:10px;"><span class="rank-icon">${rk.icon}</span> ${p.name} ${getMedals(p, playerStatsGlobal._max)}</td>
                <td>${p.wins}</td><td>${rate}</td><td>${p.mvpCount}</td>`;
            tb.appendChild(tr);
        });
    }

    function renderAnalysisPairs(ps) {
        const tb = document.getElementById('pairRankingBody'); tb.innerHTML="";
        const pairs = Object.entries(ps).map(([n,s])=>({name:n,...s})).filter(p=>p.total>=2)
            .sort((a,b)=>{ const rA=a.wins/a.total, rB=b.wins/b.total; if(rA!==rB) return rB-rA; return a.wins-b.wins; });
        if(pairs.length===0) { tb.innerHTML='<tr><td colspan="4" class="no-data">„Éá„Éº„Çø‰∏çË∂≥ (2Ë©¶Âêà‰ª•‰∏ä)</td></tr>'; return; }
        pairs.forEach((p,i)=>{
            const tr = document.createElement('tr');
            const rate = (p.wins/p.total*100).toFixed(1)+'%';
            const pct = (p.wins/p.total)*100;
            const bar = `background:linear-gradient(90deg, rgba(0,200,255,0.15) ${pct}%, transparent ${pct}%)`;
            tr.innerHTML = `<td class="${i===0?'rank-1':''}">${i+1}</td><td style="font-size:0.8rem;">${p.name}</td><td>${p.wins}-${p.losses}</td><td style="${bar}">${rate}</td>`;
            tb.appendChild(tr);
        });
    }

    function renderAnalysisLogs(logs) {
        const c = document.getElementById('logsContainer'); c.innerHTML="";
        Object.keys(logs).sort().reverse().forEach(k => {
            const l = logs[k];
            let ds = {};
            l.records.forEach(r => { if(!ds[r.name]) ds[r.name]={n:r.name,w:0,l:0}; ds[r.name].w+=parseInt(r.win); ds[r.name].l+=parseInt(r.lose); });
            const sD = Object.values(ds).sort((a,b)=>{ const rA=(a.w+a.l)>0?a.w/(a.w+a.l):0; const rB=(b.w+b.l)>0?b.w/(b.w+b.l):0; if(rA!==rB) return rB-rA; return b.w-a.w; });
            const winner = sD.length > 0 ? sD[0].n : '-';
            const div = document.createElement('div'); div.className="log-item";
            div.innerHTML = `
                <div class="log-header" onclick="this.nextElementSibling.classList.toggle('open')">
                    <div><span class="log-date">${l.date}</span><span class="log-court">@${l.court}</span></div>
                    <div style="font-size:0.7rem;color:#aaa;">TOP: ${winner}</div>
                </div>
                <div class="log-content"><table class="standard-table"><thead><tr><th>È†Ü‰Ωç</th><th>ÂêçÂâç</th><th>ÂãùÊïó</th><th>ÂãùÁéá</th></tr></thead><tbody>
                ${sD.map((r,i)=>`<tr><td style="color:${i==0?'#fff':''}">${i+1}</td><td>${r.n}</td><td>${r.w}-${r.l}</td><td>${((r.w+r.l)>0?((r.w/(r.w+r.l))*100).toFixed(0)+'%':'-')}</td></tr>`).join('')}
                </tbody></table></div>`;
            c.appendChild(div);
        });
    }

    function renderAnalysisChart(players) {
        if(winRateChartInstance) winRateChartInstance.destroy();
        const ctx = document.getElementById('winRateChart').getContext('2d');
        const tops = players.slice(0,5);
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: tops.map(p=>p.name),
                datasets: [{ label:'ÂãùÁéá (%)', data: tops.map(p=>(p.wins+p.losses)>0?p.wins/(p.wins+p.losses)*100:0), backgroundColor:'rgba(255,255,255,0.1)', borderColor:'#fff', borderWidth:1 }]
            },
            options: { 
                responsive:true, 
                maintainAspectRatio:false, 
                scales:{y:{beginAtZero:true,max:100,grid:{color:'rgba(255,255,255,0.05)'}},x:{grid:{display:false}}},
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function showModal(name) {
        const p = playerStatsGlobal[name]; const max = playerStatsGlobal._max; if(!p) return;
        document.getElementById('modalPlayerName').textContent = p